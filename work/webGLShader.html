<!DOCTYPE html>
<html>
    <head>
        <title>WebGL Shader</title>
        <script src="https://aframe.io/releases/0.4.0/aframe.min.js"></script>
        <script src="glsl/testImport.js"></script>
    </head>
    <body>

        <script id="fragmentShader" type="x-shader/x-fragment">
            #define PHONG
            uniform vec3 diffuse;
            uniform vec3 emissive;
            uniform vec3 specular;
            uniform float shininess;
            uniform float opacity;
            #include <common>
            #include <packing>
            #include <color_pars_fragment>
            #include <uv_pars_fragment>
            #include <uv2_pars_fragment>
            #include <map_pars_fragment>
            #include <alphamap_pars_fragment>
            #include <aomap_pars_fragment>
            #include <lightmap_pars_fragment>
            #include <emissivemap_pars_fragment>
            #include <envmap_pars_fragment>
            #include <fog_pars_fragment>
            #include <bsdfs>
            #include <lights_pars>
            #include <lights_phong_pars_fragment>
            #include <shadowmap_pars_fragment>
            #include <bumpmap_pars_fragment>
            #include <normalmap_pars_fragment>
            #include <specularmap_pars_fragment>
            #include <logdepthbuf_pars_fragment>
            #include <clipping_planes_pars_fragment>
            void main() {
                #include <clipping_planes_fragment>
                
                vec4 diffuseColor = vec4( diffuse, opacity );
                ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
                
                vec3 totalEmissiveRadiance = emissive;
                #include <logdepthbuf_fragment>
                #include <map_fragment>
                #include <color_fragment>
                #include <alphamap_fragment>
                #include <alphatest_fragment>
                #include <specularmap_fragment>
                #include <normal_flip>
                #include <normal_fragment>
                #include <emissivemap_fragment>
                #include <lights_phong_fragment>
                #include <lights_template>
                #include <aomap_fragment>
                
                vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
                
                #include <envmap_fragment>
                
                const vec3 W = vec3(0.25, 0.5, 0.25);
                float luminance = dot(vec3(diffuseColor), W * 1.1);
                gl_FragColor = vec4( outgoingLight, 1.0 - luminance );
                
                #include <premultiplied_alpha_fragment>
                #include <tonemapping_fragment>
                #include <encodings_fragment>
                #include <fog_fragment>
            }
        </script>
        
        <script>
            
            AFRAME.registerComponent('custom_shader', {
                init: function () {
                    
                    var vertexShader = THREE.ShaderLib.phong.vertexShader;
                    var fragmentShader = document.getElementById('fragmentShader').text;
                    var uniforms = THREE.UniformsUtils.clone(THREE.ShaderLib.phong.uniforms);
                    
                    var defines = {};
                    defines[ "USE_MAP" ] = "";
                    
                    var loader = new THREE.TextureLoader();
                    var color_map = loader.load( 'img/colored.jpg' );
                    var normal_map = loader.load( 'img/ink_normal.jpg' );
                    
                    // SET UNIFORMS //
                    uniforms.specular = { type: "c", value: new THREE.Color( 0x3e444c )};
                    uniforms.shininess = { type: "f", value: 10 };
                    uniforms.map = { type: "t", value: color_map};
                    uniforms.normalMap = { type: "t", value: normal_map};
                    uniforms.normalScale = { type: "v2", value: new THREE.Vector2( 0.25, 0.25 )};
                    
                    //console.log(uniforms.normalScale);
                    
                    var material = new THREE.ShaderMaterial( {
                        vertexShader: vertexShader,
                        fragmentShader: fragmentShader,
                        uniforms: uniforms,
                        defines: defines,
                        lights: true,
                        fog: false,
                        transparent: true,
                        depthTest: true, 
                        depthWrite: false, 
                        polygonOffset: true,
                        polygonOffsetFactor: -4
                    } );
                    
                    var mesh = this.el.getObject3D('mesh');
                    mesh.material = material;
   
                    /*// Decal Material
                    mesh.material = new THREE.MeshPhongMaterial( { 
                        specular: 0xffffff,
                        shininess: 10,
                        map: loader.load( 'img/colored.jpg' ), 
                        normalMap: loader.load( 'img/ink_normal.jpg' ),
                        normalScale: new THREE.Vector2( 5.0, 5.0 ),
                        transparent: true, 
                        depthTest: true, 
                        depthWrite: false, 
                        polygonOffset: true,
                        polygonOffsetFactor: -4, 
                        wireframe: false 
                    });*/
                    
                    //console.log(mesh.material.normalScale);
                
                }
            });
            
        </script>
        
        <a-scene>
           
            <!-- CAMERA AND RAYCASTER -->
            <a-camera position="0 -1 3"></a-camera>
            
            <!-- LIGHTS AND BG -->
            <a-sky color="#2980b9"></a-sky>
            
            <!-- BOX -->
            <a-torus custom_shader></a-torus>
            
        </a-scene>
    </body>
</html>